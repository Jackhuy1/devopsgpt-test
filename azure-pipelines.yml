trigger:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  registry: 'myregistry.azurecr.io'
  imageName: 'free_demo'
  imageTag: '$(Build.BuildId)'
  aksResourceGroup: 'myAksResourceGroup'
  aksClusterName: 'myAksCluster'
  azureServiceConnection: 'myAzureServiceConnection'
  - name: acrUsername
    value: 'realAcrUsername'
    isSecret: true
  - name: acrPassword
    value: 'realAcrPassword'
    isSecret: true
  - name: acrEmail
    value: 'realAcrEmail@example.com'
    isSecret: true

steps:
- task: Checkout@1
  displayName: 'Checkout repository code'

- task: Docker@2
  displayName: 'Build Docker Image'
  inputs:
    containerRegistry: '$(registry)'
    repository: '$(imageName)'
    command: 'build'
    Dockerfile: 'Dockerfile'
    tags: '$(imageTag)'

- task: Docker@2
  displayName: 'Push Docker Image to Registry'
  inputs:
    containerRegistry: '$(registry)'
    repository: '$(imageName)'
    command: 'push'
    tags: '$(imageTag)'

- script: |
    kubectl delete secret acr-secret --ignore-not-found
    kubectl create secret docker-registry acr-secret \
      --docker-server=$(registry) \
      --docker-username=$(acrUsername) \
      --docker-password=$(acrPassword) \
      --docker-email=$(acrEmail)
  displayName: 'Create Kubernetes Secret for ACR'

- task: AzureCLI@2
  displayName: 'Get AKS Kubeconfig'
  inputs:
    azureSubscription: '$(azureServiceConnection)'
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
      az aks get-credentials --resource-group $(aksResourceGroup) --name $(aksClusterName) --overwrite-existing

- script: |
    kubectl apply -f deployment.yaml
    kubectl apply -f service.yaml
    kubectl apply -f ingress.yaml
  displayName: 'Deploy to Azure Kubernetes Service'